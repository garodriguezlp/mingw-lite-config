#!/bin/bash
# MinGW-Lite Configuration Compiler

set -e  # Exit on error

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"
CORE_FILE="$PROJECT_ROOT/core.sh"
PLUGINS_DIR="$PROJECT_ROOT/plugins"
OUTPUT_FILE="$HOME/.bash_compiled"

# =============================================================================
# Functions
# =============================================================================

log() {
    echo "$@" >&2
}

extract_plugins() {
    # Extract plugin names from PLUGINS=(...) array in core.sh
    # Returns plugin names, one per line
    grep -A 100 '^[[:space:]]*PLUGINS=(' "$CORE_FILE" | \
        grep -B 100 '^[[:space:]]*)' | \
        grep -v 'PLUGINS=' | \
        grep -v ')' | \
        sed 's/["\047]//g' | \
        sed 's/#.*//' | \
        xargs -n1 | \
        grep -v '^$'
}

write_header() {
    cat > "$OUTPUT_FILE" << 'EOF'
#!/bin/bash
# =============================================================================
# MinGW-Lite Compiled Configuration
# =============================================================================
# This file is AUTO-GENERATED by mingw-compile
# DO NOT EDIT MANUALLY - Changes will be overwritten
#
# To modify configuration:
#   1. Edit files in bash/plugins/
#   2. Run bash/bin/mingw-compile
#   3. Restart your shell
#
# =============================================================================

EOF
}

write_config_dir() {
    cat >> "$OUTPUT_FILE" << EOF
# Configuration directory (needed for lazy loader)
BASH_CONFIG_DIR="$PROJECT_ROOT"

EOF
}

write_local_env_section() {
    local local_env_file="$HOME/.local-env.sh"

    cat >> "$OUTPUT_FILE" << 'EOF'

# =============================================================================
# Optional User-Specific Local Environment
# =============================================================================
# This section is FLATTENED at compile time (not sourced at runtime)
# To modify: Edit ~/.local-env.sh and recompile with mingw-compile

EOF

    if [ -f "$local_env_file" ]; then
        log "  ✓ Flattening: ~/.local-env.sh"

        # Add timestamp comment
        echo "# Flattened from: $local_env_file" >> "$OUTPUT_FILE"
        echo "# Compiled at: $(date '+%Y-%m-%d %H:%M:%S')" >> "$OUTPUT_FILE"
        echo "" >> "$OUTPUT_FILE"

        # Flatten the content (skip shebang if present)
        grep -v '^#!/bin/bash' "$local_env_file" >> "$OUTPUT_FILE" 2>/dev/null || \
            cat "$local_env_file" >> "$OUTPUT_FILE"
    else
        echo "# Note: No ~/.local-env.sh file found at compile time" >> "$OUTPUT_FILE"
        echo "# To add local environment variables, create ~/.local-env.sh and recompile" >> "$OUTPUT_FILE"
    fi

    cat >> "$OUTPUT_FILE" << 'EOF'

# =============================================================================
# End: Local Environment
# =============================================================================

EOF
}

write_plugin() {
    local plugin="$1"
    local plugin_path="$PLUGINS_DIR/$plugin.sh"

    if [ ! -f "$plugin_path" ]; then
        log "  ⚠️  Warning: $plugin not found, skipping..."
        return 1
    fi

    log "  ✓ Compiling: $plugin"

    # Section header
    cat >> "$OUTPUT_FILE" << EOF

# =============================================================================
# Plugin: $plugin
# =============================================================================

EOF

    # Plugin content (skip shebang if present)
    grep -v '^#!/bin/bash' "$plugin_path" >> "$OUTPUT_FILE" 2>/dev/null || \
        cat "$plugin_path" >> "$OUTPUT_FILE"

    # Section footer
    cat >> "$OUTPUT_FILE" << EOF

# =============================================================================
# End: $plugin
# =============================================================================

EOF
}


validate_syntax() {
    if bash -n "$OUTPUT_FILE" 2>/dev/null; then
        log "✓ Syntax validation passed"
        return 0
    else
        log "⚠️  Warning: Syntax validation failed - check the output file"
        return 1
    fi
}

# =============================================================================
# Main
# =============================================================================

log "MinGW-Lite Configuration Compiler"
log "=================================="
log ""

# Verify core.sh exists
if [ ! -f "$CORE_FILE" ]; then
    log "Error: core.sh not found at $CORE_FILE"
    exit 1
fi

# Extract plugin list
log "Parsing core.sh to extract plugin order..."
mapfile -t PLUGINS < <(extract_plugins)

if [ ${#PLUGINS[@]} -eq 0 ]; then
    log "Error: No plugins found in core.sh"
    exit 1
fi

log "Found ${#PLUGINS[@]} plugins:"
for plugin in "${PLUGINS[@]}"; do
    log "  - $plugin"
done
log ""

# Compile
log "Compiling configuration..."
log ""

write_header
write_config_dir

# Add optional local environment section FIRST
write_local_env_section

for plugin in "${PLUGINS[@]}"; do
    write_plugin "$plugin" || true  # Continue even if plugin missing
done

# Make executable
chmod +x "$OUTPUT_FILE" 2>/dev/null || true

log ""
log "✓ Compilation complete!"
log "  Output: $OUTPUT_FILE"
log ""
log "To use the compiled version, update ~/.bashrc to source:"
log "  source $OUTPUT_FILE"
log ""

# Validate
validate_syntax || exit 1
